# 機能仕様（What）

## コア機能

* **インラインコメント作成**

  * エディタで範囲選択 → コマンド実行 → 「レビュー種別」を選択（QuickPick） → エディタ内の\*\*複数行Markdown入力欄（Comments UI）\*\*で本文を記入（コードブロック可）。
  * 範囲なしの**ファイル全体コメント**も可。
* **スレッド & リプライ**

  * コメントはスレッド化（時系列・折りたたみ）。
  * **サイドバーのレビュー詳細ビュー**からも返信・追記・状態更新が可能。
* **状態管理**

  * 基本状態：`Open / Resolved`
  * 任意フラグ：`Fixed（修正完了）`、`NeedsResponse（返信待ち）`
* **レビュー一覧（サイドバー）**

  * 「未解決 / 解決」→ ファイル → スレッドのツリー。
  * クリックで本文プレビュー・対象コードへジャンプ。
  * 絞り込み（状態/種別/作者/更新日/キーワード）と並び替え。
* **コード上の視認性・ナビゲーション**

  * **CodeLens**：対象行の**上**に「💬件数・種別・状態」のリンクを表示（クリックでスレッドへ）。
  * **Inlay Hints**：対象行の**行内**に小バッジ（例：✅Fixed／📣Reply／🟡Open）。
  * **Text Editor Decorations**：**ガター**と**スクロールバー**（overview ruler）に印を表示。hover で「Open」リンク。
* **適用補助（任意）**

  * コメント本文に「この修正を適用」ボタン（コマンドリンク）を表示し、クリックで提案コードを適用（確認ダイアログあり）。
* **保存・共有（ローカル完結）**

  * リポジトリ配下の既定保存先（例：`.codereview/`）に**人間可読なテキスト形式**で保存。
  * Git で共有可能。**完了（Resolved/Fixed）レビューはファイル削除**などの運用で整理可能。
* **アンカー安定化（位置ずれ対策）**

  * 範囲の前後文脈や抜粋を保存し、編集後も再アンカー。
  * 再アンカーが不確実な場合は警告表示・手動再アンカー導線を提供。
* **利用フロー（要約）**

  * **レビュワー**：範囲選択 → 種別選択 → コメント入力 → 保存 → Git でコミット/プッシュ
  * **実装者**：Git でプル → サイドバー一覧 → 詳細で確認/返信/フラグ更新 → コードへジャンプ → 修正

---

# 技術仕様（How）

## VS Code API 採用

* **Comments API**：スレッド生成・表示・インライン複数行入力欄。
* **TreeView API**：レビュー一覧（Review Explorer）。
* **WebviewView**：レビュー詳細ペイン（本文表示・返信入力・状態切替）。
* **CodeLens API**：行上リンク（💬件数・種別・状態）。
* **Inlay Hints API**：行内バッジ（状態や返信要否）。
* **Text Editor Decorations**：ガター/スクロールバーの印＋hoverリンク。
* **WorkspaceEdit**：提案コード適用（任意機能）。
* **QuickPick/Input**：レビュー種別選択などの軽量入力。
* **FileSystemWatcher / workspace.findFiles**：保存ファイルの監視・スキャン。
* **Commands & Menus**：エディタ右クリック、コメントタイトルメニュー、ビュー内操作。

## データモデル（概念）

* **スレッド**：`id / file / range / type / state / flags({fixed, needsResponse}) / comments[] / timestamps`
* **アンカー情報**：選択抜粋＋前後文脈（再アンカー用）
* **スキーマバージョン**：将来拡張に備え付与

## 保存ファイル（方針）

* **保存場所**：既定はリポジトリ直下の専用ディレクトリ（例：`.codereview/`）。設定で変更可。マルチルートWS・追加探索ディレクトリにも対応。
* **粒度**：**スレッド＝1ファイル**（人間可読なテキスト形式）。

  * 長文やコードブロックでも**エスケープが増えない**形式を採用（例：本文はプレーンMarkdown、メタは先頭に軽量メタデータ）。
  * これにより Git 差分が読みやすく、手作業での修正にも強い。
* **ライフサイクル**：

  * Open 中は保持／ステータス変更で更新。
  * Resolved/Fixed となったレビューは、**運用ポリシーに応じてファイル削除**や**アーカイブ**を推奨。
* **パフォーマンス**：ファイル数が増える場合に備え、起動時キャッシュ（任意の index ファイル）を用意可能（なくても動作）。

## 再アンカー（概略アルゴリズム）

1. 既存座標で一致すれば採用。
2. 選択抜粋の先頭行・特徴語を全文検索し近傍に再配置。
3. 前後文脈（数行）を照合しスコアで最良候補に再アンカー。
4. 閾値未満は「位置不確実」扱い（黄色装飾・再アンカー操作を提示）。

## 設定項目（例）

* 保存先パス／追加探索ディレクトリ
* アンカー用文脈行数
* CodeLens / Inlay / Decorations の表示ON/OFF
* 返信待ちの既定挙動、適用ボタンの有効化
* ログレベル（info/warn/diagnostic）

## 品質・UX

* パフォーマンス：可視エディタ優先の遅延更新、監視イベントのデバウンス
* アクセシビリティ/テーマ対応：高コントラスト、テーマカラー、キーボード操作
* エラーハンドリング：保存エラー・競合（Gitマージ）検知と復旧ガイド
* セキュリティ：外部連携なし（完全ローカル）。Webviewの権限は**最小許可**（許可コマンドを限定）。

## 互換・配布

* 対応：Windows/macOS/Linux（VS Code エンジン要件を明記）
* 配布：**vsce** でパッケージ化した **.vsix** をローカル配布／導入
* 依存は最小限（保存読み書き用の軽量パーサ程度）

## テスト

* 単体：保存・読込・再アンカー
* UIスモーク：作成→保存→一覧→ジャンプ→返信→完了→再起動復元
* 回帰：巨大ファイル、CRLF/LF、UTF-8/Shift-JIS 混在
* 競合：双方で同一スレッド更新→解決手順

